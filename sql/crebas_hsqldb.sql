create cached table dbversion
(
    dbversion_id    int generated by default as identity (start with 1),
    version_id      int not null,
    version         varchar(12),
    constraint dbversion_pk primary key (dbversion_id)
);

insert into dbversion values(1,3,'0.03');


create cached table picture
(
    picture_id   int generated by default as identity (start with 1),
    picture      other,
    constraint picture_pk primary key (picture_id)
);

create cached table xsite
(
    xsite_id        int generated by default as identity (start with 1),
    name            varchar(32) not null,
    description     varchar(255),
    dieselsponsor   smallint default 0,
    sitetype        char(1),
    constraint xsite_id primary key (xsite_id)
);

create cached table xclient
(
    xclient_id      int generated by default as identity (start with 1),
    clientcode      varchar(16) not null,
    companyname     varchar(255) not null,
    contactname	    varchar(255),
    phonenumber	    varchar(12),
    vatnumber       varchar(32),
    address	    varchar(255),
    description     varchar(255),
    constraint xclient_pk primary key (xclient_id)
);

create cached table xcontract
(
    xcontract_id   int generated by default as identity (start with 1),
    contractref    varchar(32) not null,
    description    varchar(255),
    xclient_id     int not null,
    constraint xcontract_pk primary key (xcontract_id),
    constraint xcontract_xclient_fk foreign key (xclient_id) references xclient
);

create cached table xcontractpage
(
    xcontractpage_id   int generated by default as identity (start with 1),
    xcontract_id       int not null,
    pagenum            int,
    description        varchar(64),
    pagescan           other, 
    constraint xcontractpage_pk primary key (xcontractpage_id),
    constraint xcontractpage_xcontract_fk foreign key (xcontract_id) references xcontract on delete cascade
);
 
create cached table xorder
(
    xorder_id          int generated by defaule as identity (start with 1),
    xclient_id         int not null,
    xcontract_id       int,
    vatnumber          varchar(32) not null,
    regnumber          varchar(32) not null,
    ordernumber        varchar(32) not null,
    orderdate          date not null,
    contactname        varchar(255),
    contactphone       varchar(32),
    contactfax         varchar(32),
    deliveryaddress    varchar(255) not null,
    invoiceaddress     varchar(255) not null,
    constraint xorder_pk primary key (xorder_id),
    constraint xorder_xclient_fk foreign key (xclient_id) references xclient,
    constraint xorder_xcontract foreign key (xcontract_id) references xcontract
);                            

create cached table xorderitem
(
    xorderitem_id     int generated by defaule as identity (start with 1),
    xorder_id         int not null,
    itemnumber        varchar(16) not null,
    materialnumber    varchar(16),
    description       varchar(255) not null,
    quantity          int not null,
    measureitem       varchar(8),
    priceperone       decimal(10,2) not null,    
    constraint xorderitem_pk primary key (xorderitem_id),
    constraint xoreritem_xorder_fk foreign key (xorder_id) references xorder on delete cascade
);

create cached table profile 
(
    profile_id   int generated by default as identity (start with 1),
    first_name   varchar(32) not null,
    last_name    varchar(32) not null,
    address1     varchar(80) not null,
    address2     varchar(80),
    city         varchar(48),
    state        varchar(12),
    zip_code     varchar(12),
    phone        varchar(12),
    cell_phone   varchar(12),
    email        varchar(80),
    picture_id   int,
    constraint profile_pk primary key (profile_id),
    constraint profile_picture_fk foreign key (picture_id) references picture
);

create cached table userprofile
(
    profile_id   int not null,
    fax          varchar(12),
    webaddress   varchar(80),
    office_hours varchar(48),
    salesperson  smallint,
    manager      smallint,
    login        varchar(16),
    pwdmd5       varchar(32),
    constraint userprofile_pk primary key (profile_id),
    constraint userprofile_profile_fk foreign key (profile_id) references profile on delete cascade
);

create cached table clientprofile
(
    profile_id        int not null,
    salesperson_id    int,
    birthday          date,
    source_type       varchar(10), --check (source_type in('Phonebook','Referral','Location','Others')),
    source_descr      varchar(255),
    sales_potential   int,
    constraint clientprofile_pk primary key (profile_id),
    constraint clientprofile_profile_spers_fk foreign key (salesperson_id) references profile,
    constraint clientprofile_profile_fk foreign key (profile_id) references profile on delete cascade
);


create view v_userprofile as 
select p.profile_id,
       p.first_name,
       p.last_name,
       p.address1,
       p.address2,
       p.city,
       p.state,
       p.zip_code,
       p.phone as office_phone,
       p.cell_phone,
       u.fax,
       p.email,
       u.webaddress,
       u.office_hours,
       u.salesperson,
       u.manager    
  from profile p, userprofile u
 where u.profile_id = p.profile_id;

create or replace view v_clientprofile as
select p.profile_id,
       p.first_name,
       p.last_name,
       c.birthday,
       p.address1,
       p.address2,
       p.city,
       p.state,
       p.zip_code,
       p.phone as home_phone,
       p.cell_phone,
       p.email,
       c.source_type,
       c.source_descr,
       c.sales_potential
  from profile p, clientprofile c
 where c.profile_id = p.profile_id;

insert into profile(profile_id,first_name,last_name,address1) values(1,'Admin','Adminson','not known');
insert into userprofile(profile_id,salesperson,manager,login,pwdmd5) select profile_id,0,1,'admin','admin' from profile where first_name='Admin';

insert into profile(profile_id,first_name,last_name,address1) values(2,'Salesman','Sale','not known');
insert into userprofile(profile_id,salesperson,manager,login,pwdmd5) select profile_id,1,0,'sale','sale' from profile where first_name='Salesman';
